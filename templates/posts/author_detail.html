{% extends "posts/base.html" %}
{% load static %}
{% block title %}{{ author.username }}{% endblock %}

{% block content %}
    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å */
        .messages-container {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 90%; max-width: 600px;
        }
        .messages { list-style: none; padding: 0; margin: 0; }
        .messages li {
            padding: 10px 20px; margin-bottom: 10px; border-radius: 5px;
            color: #fff; font-weight: bold; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .messages li.success { background-color: #28a745; }
        .messages li.error { background-color: #dc3545; }
        .messages li.warning { background-color: #ffc107; color: #000; }
        .messages li.info { background-color: #17a2b8; }
    </style>

    {% if messages %}
        <div class="messages-container">
            <ul class="messages">
                {% for message in messages %}
                    <li class="{{ message.tags }}">{{ message }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <div class="container" style="padding-top: 140px;">
        
        <div class="author-card large-card">
            <div class="author-header">
                {% if author.profile.avatar %}
                    <img class="avatar-circle" src="{{ author.profile.avatar.url }}" alt="{{ author.username }}">
                {% else %}
                    <div class="avatar-circle placeholder">{{ author.username|slice:":1" }}</div>
                {% endif %}
                
                <div class="author-info">
                    <div class="username">{{ author.username }}</div>
                    
                    <div class="follow-stats">
                        <div class="followers">
                            <a href="{% url 'auth_system:followers-list' author.uuid %}">
                                <span class="count">{{ author.followers_set.count }}</span>
                            </a>
                            <a href="{% url 'auth_system:followers-list' author.uuid %}">
                                <span class="label">Followers</span>
                            </a>
                        </div>
                        <div class="following">
                            <a href="{% url 'auth_system:following-list' author.uuid %}">
                                <span class="count">{{ author.following_set.count }}</span>
                            </a>
                            <a href="{% url 'auth_system:following-list' author.uuid %}">
                                <span class="label">Following</span>
                            </a>
                        </div>
                    </div>

                    <div class="author-buttons">
                        {% if request.user == author %}
                            <a href="{% url 'auth_system:my-profile-edit' %}" class="btn-small">Edit Profile</a>
                        {% elif request.user.is_authenticated %}
                            {% if is_following %}
                                <a href="{% url 'auth_system:unfollow' author.uuid %}" class="btn-small">Unfollow</a>
                                <a href="{% url 'messages:start-thread' author.uuid %}" class="btn-small">Message</a>
                            {% else %}
                                <a href="{% url 'auth_system:follow' author.uuid %}" class="btn-small">Follow</a>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="author-bio">
                {{ author.bio|default:"<span class='no-bio'>no bio</span>"|safe }}
            </div>
            
            <div class="author-meta-info" style="margin-top: 15px; color: #777; font-size: 13px;">
                {% if author.email and request.user == author %}
                    <div class="author-email">Email: {{ author.email }}</div>
                {% endif %}
                <span>Joined: {{ author.date_joined|date:"d.m.Y" }}</span>
            </div>
        </div>

        <div class="posts-header">
            <h3>
                {% if request.user == author %}
                    My Posts
                {% else %}
                    {{ author.username }}'s Posts
                {% endif %}
            </h3>
            <a href="{% url 'post:home' %}" class="back-link">‚Üê Back to Feed</a>
        </div>

        <ul class="posts-list">
            {% for post in page_obj %}
            <li class="post-card" onclick="window.location.href='{% url 'post:post-detail' post.uuid %}'" style="cursor: pointer;">
                
                <div class="post-header">
                    {% if post.author.profile.avatar %}
                        <img class="post-avatar" src="{{ post.author.profile.avatar.url }}" alt="{{ post.author.username }}">
                    {% else %}
                        <div class="post-avatar placeholder">{{ post.author.username|slice:":1" }}</div>
                    {% endif %}
                    
                    <div class="post-info">
                        <span class="post-author" style="font-weight: 600; color: #333;">{{ post.author.username }}</span>
                        <span class="post-date">{{ post.created_at|date:"d.m.Y H:i" }}</span>
                    </div>
                </div>

                <div class="post-title">{{ post.title }}</div>
                <p class="post-content">{{ post.content|truncatewords:30 }}</p>

                {# üî• –ö–ê–†–¢–ò–ù–ö–ê (—Ç–µ–ø–µ—Ä —î —ñ —Ç—É—Ç) #}
                {% if post.image %}
                    <div class="post-image-wrapper">
                        <img src="{{ post.image.url }}" alt="Post Image" loading="lazy">
                    </div>
                {% endif %}

                <div class="post-actions" onclick="event.stopPropagation();">
                    
                    {% if request.user.is_authenticated %}
                        <form class="like-form" action="{% url 'post:post-like' post.uuid %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="like-btn">
                                {% if post.post_liked_by_current_user %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
                            </button>
                            <span class="like-count">Likes: {{ post.likes_post.count }}</span>
                        </form>
                    {% else %}
                        <div class="like-disabled" style="display: inline-flex; align-items: center;">
                            <span style="font-size: 16px; margin-right: 4px;">ü§ç</span>
                            <span class="like-count">Likes: {{ post.likes_post.count }}</span>
                        </div>
                    {% endif %}

                    <a href="{% url 'post:post-detail' post.uuid %}" class="comment-link">üí¨ Comments</a>
                </div>
            </li>
            {% empty %}
                <li style="text-align: center; color: #777; padding: 20px;">
                    No posts yet.
                    {% if request.user == author %}
                         <a href="{% url 'post:post-create' %}" style="color: #333; font-weight: bold;">Create one?</a>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}">‚Üê Back</a>
            {% endif %}
            <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">Next ‚Üí</a>
            {% endif %}
        </div>
    </div>

<style>
.container { max-width: 900px; margin: 0 auto; padding: 0 15px; }
.author-card.large-card { background-color: #fff; border-radius: 20px; padding: 30px 36px; margin-bottom: 40px; box-shadow: 0 12px 24px rgba(0,0,0,0.08); }
.author-header { display: flex; align-items: center; margin-bottom: 20px; position: relative; }
.avatar-circle { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; margin-right: 24px; }
.avatar-circle.placeholder { background-color: #ccc; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 40px; }
.author-info { margin-left: auto; width: 70%; }
.username { font-size: 28px; font-weight: 700; margin-bottom: 6px; text-align: left; }
.follow-stats { display: flex; gap: 30px; }
.follow-stats .followers, .follow-stats .following { display: flex; flex-direction: column; align-items: flex-start; }
.follow-stats .count { font-size: 27px; font-weight: 700; }
.follow-stats .label { font-size: 12px; color: rgba(0,0,0,0.6); }
.author-bio { font-size: 16px; margin-bottom: 8px; color: #333; }
.author-bio .no-bio { color: rgba(0,0,0,0.4); font-style: italic; }
.author-email { font-size: 14px; color: #555; margin-bottom: 16px; }
.author-buttons { margin-top: 10px; display: flex; gap: 10px; }
.btn-small { padding: 6px 18px; font-size: 14px; background-color: #333; color: #fff; text-decoration: none; border-radius: 10px; transition: background 0.3s; }
.btn-small:hover { background-color: #555; }
.posts-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; color: #333; }
.posts-header h3 { margin: 0; font-size: 20px; }
.back-link { text-decoration: none; color: #333; padding: 4px 8px; border-radius: 8px; background-color: rgba(0,0,0,0.05); transition: background 0.3s; }
.back-link:hover { background-color: rgba(0,0,0,0.1); }
.posts-list { list-style: none; padding: 0; margin: 0; }
.post-card { background-color: #fff; border-radius: 14px; padding: 18px 22px; margin-bottom: 16px; box-shadow: 0 6px 12px rgba(0,0,0,0.06); transition: background 0.2s; }
.post-card:hover { background-color: #f5f5f5; }
.post-header { display: flex; align-items: center; margin-bottom: 8px; }
.author-link-wrapper { text-decoration: none; display: block; }
.post-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 12px; }
.post-avatar.placeholder { background-color: #ccc; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 20px; }
.post-info { display: flex; flex-direction: column; }
.post-author { font-weight: 600; font-size: 16px; text-decoration: none; color: #333; }
.post-date { font-size: 12px; color: #777; }
.post-title { font-weight: 700; font-size: 18px; margin: 6px 0; color: #222; }
.post-content { font-size: 14px; margin-bottom: 10px; color: #444; }
.post-actions { display: flex; align-items: center; gap: 12px; }
.like-btn { background: none; border: none; cursor: pointer; font-size: 16px; }
.comment-link { text-decoration: none; font-size: 14px; color: #555; }
.comment-link:hover { text-decoration: underline; }
.pagination { display: flex; justify-content: center; gap: 15px; margin-top: 20px; margin-bottom: 40px; }
.pagination a { text-decoration: none; color: #333; font-weight: bold; }

/* –°—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
.post-image-wrapper {
    margin-top: 15px;
    margin-bottom: 15px;
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #f0f0f0;
}
.post-image-wrapper img {
    width: 100%;
    height: auto;
    max-height: 500px;
    object-fit: cover;
    display: block;
}
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const messages = document.querySelector('.messages-container');
        if (messages) {
            setTimeout(function() {
                messages.style.transition = "opacity 0.5s ease";
                messages.style.opacity = "0";
                setTimeout(() => messages.remove(), 500);
            }, 4000);
        }
    });

    document.querySelectorAll('.like-form').forEach(form => {
        form.addEventListener('submit', function(e){
            e.preventDefault();
            e.stopPropagation(); 
            const url = form.action;
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                form.querySelector('.like-btn').textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
                const countSpan = form.querySelector('.like-count');
                if(countSpan) countSpan.textContent = `Likes: ${data.likes_count}`;
            });
        });
    });

    const cards = document.querySelectorAll('.post-card');
    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.4, rootMargin: "0px 0px -60px 0px" });
    cards.forEach(card => observer.observe(card));
</script>
{% endblock %}
